name: Publish to pub.dev

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v0.0.1, v1.0.0, etc.
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to publish (all, gameframework, gameframework_unity, gameframework_unreal)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - gameframework
          - gameframework_unity
          - gameframework_unreal
      dry_run:
        description: 'Run in dry-run mode (validate but do not publish)'
        required: false
        default: true
        type: boolean

jobs:
  # Validate all packages before publishing
  validate:
    name: Validate Packages
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package:
          - name: gameframework
            path: packages/gameframework
          - name: gameframework_unity
            path: engines/unity/dart
          - name: gameframework_unreal
            path: engines/unreal/dart
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.x'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        working-directory: ${{ matrix.package.path }}
        run: flutter pub get

      - name: Analyze code
        working-directory: ${{ matrix.package.path }}
        run: flutter analyze

      - name: Run tests
        working-directory: ${{ matrix.package.path }}
        run: flutter test

      - name: Validate package
        working-directory: ${{ matrix.package.path }}
        run: dart pub publish --dry-run

  # Publish gameframework (core package) first
  publish-gameframework:
    name: Publish gameframework
    needs: validate
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.package == 'all' || github.event.inputs.package == 'gameframework'))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.x'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        working-directory: packages/gameframework
        run: flutter pub get

      - name: Setup pub credentials
        if: github.event.inputs.dry_run != 'true'
        run: |
          mkdir -p $HOME/.pub-cache
          echo '${{ secrets.PUB_CREDENTIALS }}' > $HOME/.pub-cache/credentials.json

      - name: Publish to pub.dev (dry-run)
        if: github.event.inputs.dry_run == 'true'
        working-directory: packages/gameframework
        run: dart pub publish --dry-run

      - name: Publish to pub.dev
        if: github.event.inputs.dry_run != 'true'
        working-directory: packages/gameframework
        run: dart pub publish --force

      - name: Extract version
        if: github.event.inputs.dry_run != 'true'
        id: version
        working-directory: packages/gameframework
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Published gameframework v$VERSION"

  # Publish Unity plugin individually (manual dispatch only)
  publish-unity:
    name: Publish gameframework_unity
    needs: [validate, publish-gameframework]
    runs-on: ubuntu-latest
    if: |
      always() &&
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.package == 'gameframework_unity'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.x'
          channel: 'stable'
          cache: true

      - name: Wait for gameframework availability
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "Waiting 60 seconds for gameframework to be available on pub.dev..."
          sleep 60

      - name: Get dependencies
        working-directory: engines/unity/dart
        run: flutter pub get

      - name: Setup pub credentials
        if: github.event.inputs.dry_run != 'true'
        run: |
          mkdir -p $HOME/.pub-cache
          echo '${{ secrets.PUB_CREDENTIALS }}' > $HOME/.pub-cache/credentials.json

      - name: Publish to pub.dev (dry-run)
        if: github.event.inputs.dry_run == 'true'
        working-directory: engines/unity/dart
        run: dart pub publish --dry-run

      - name: Publish to pub.dev
        if: github.event.inputs.dry_run != 'true'
        working-directory: engines/unity/dart
        run: dart pub publish --force

      - name: Extract version
        if: github.event.inputs.dry_run != 'true'
        id: version
        working-directory: engines/unity/dart
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Published gameframework_unity v$VERSION"

  # Publish Unreal plugin individually (manual dispatch only)
  publish-unreal:
    name: Publish gameframework_unreal
    needs: [validate, publish-gameframework]
    runs-on: ubuntu-latest
    if: |
      always() &&
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.package == 'gameframework_unreal'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.x'
          channel: 'stable'
          cache: true

      - name: Wait for gameframework availability
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "Waiting 60 seconds for gameframework to be available on pub.dev..."
          sleep 60

      - name: Get dependencies
        working-directory: engines/unreal/dart
        run: flutter pub get

      - name: Setup pub credentials
        if: github.event.inputs.dry_run != 'true'
        run: |
          mkdir -p $HOME/.pub-cache
          echo '${{ secrets.PUB_CREDENTIALS }}' > $HOME/.pub-cache/credentials.json

      - name: Publish to pub.dev (dry-run)
        if: github.event.inputs.dry_run == 'true'
        working-directory: engines/unreal/dart
        run: dart pub publish --dry-run

      - name: Publish to pub.dev
        if: github.event.inputs.dry_run != 'true'
        working-directory: engines/unreal/dart
        run: dart pub publish --force

      - name: Extract version
        if: github.event.inputs.dry_run != 'true'
        id: version
        working-directory: engines/unreal/dart
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Published gameframework_unreal v$VERSION"

  # Publish Unity and Unreal plugins in parallel (after core package)
  publish-engine-plugins:
    name: Publish ${{ matrix.package.name }}
    needs: publish-gameframework
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.package == 'all')
    strategy:
      matrix:
        package:
          - name: gameframework_unity
            path: engines/unity/dart
          - name: gameframework_unreal
            path: engines/unreal/dart
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.x'
          channel: 'stable'
          cache: true

      # Wait for gameframework to be available on pub.dev
      - name: Wait for gameframework availability
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "Waiting 60 seconds for gameframework to be available on pub.dev..."
          sleep 60

      - name: Get dependencies
        working-directory: ${{ matrix.package.path }}
        run: flutter pub get

      - name: Setup pub credentials
        if: github.event.inputs.dry_run != 'true'
        run: |
          mkdir -p $HOME/.pub-cache
          echo '${{ secrets.PUB_CREDENTIALS }}' > $HOME/.pub-cache/credentials.json

      - name: Publish to pub.dev (dry-run)
        if: github.event.inputs.dry_run == 'true'
        working-directory: ${{ matrix.package.path }}
        run: dart pub publish --dry-run

      - name: Publish to pub.dev
        if: github.event.inputs.dry_run != 'true'
        working-directory: ${{ matrix.package.path }}
        run: dart pub publish --force

      - name: Extract version
        if: github.event.inputs.dry_run != 'true'
        id: version
        working-directory: ${{ matrix.package.path }}
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Published ${{ matrix.package.name }} v$VERSION"

  # Create GitHub release
  create-release:
    name: Create GitHub Release
    needs: [publish-gameframework, publish-engine-plugins]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: tag_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Read CHANGELOG
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            # Extract the latest changelog entry
            CHANGELOG=$(awk '/^## \[?[0-9]/{if(++count==2) exit} count==1' CHANGELOG.md)
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "changelog=No changelog available" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ steps.tag_version.outputs.version }}
          body: |
            ## Flutter Game Framework ${{ steps.tag_version.outputs.version }}
            
            Published packages:
            - [gameframework](https://pub.dev/packages/gameframework)
            - [gameframework_unity](https://pub.dev/packages/gameframework_unity)
            - [gameframework_unreal](https://pub.dev/packages/gameframework_unreal)
            
            ### Changelog
            ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: ${{ contains(steps.tag_version.outputs.version, '-') }}
